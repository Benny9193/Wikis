---
import WikiArticle from '../../layouts/WikiArticle.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const lore = await getCollection('lore', ({ data }) => !data.draft);
  const allLore = await getCollection('lore', ({ data }) => !data.draft);
  const factions = await getCollection('factions', ({ data }) => !data.draft);
  const locations = await getCollection('locations', ({ data }) => !data.draft);
  const characters = await getCollection('characters', ({ data }) => !data.draft);

  const sortedLore = [...lore].sort((a, b) => a.data.title.localeCompare(b.data.title));

  return lore.map(entry => {
    const currentIndex = sortedLore.findIndex(l => l.slug === entry.slug);
    const previousArticle = currentIndex > 0 ? sortedLore[currentIndex - 1] : null;
    const nextArticle = currentIndex < sortedLore.length - 1 ? sortedLore[currentIndex + 1] : null;
    const loreGames = entry.data.games || [];
    const loreCategory = entry.data.category;

    const relatedLore = allLore
      .filter(l => l.slug !== entry.slug)
      .filter(l => {
        const sameGame = (l.data.games || []).some(g => loreGames.includes(g));
        const sameCategory = l.data.category === loreCategory;
        return sameGame || sameCategory;
      })
      .slice(0, 3)
      .map(l => ({
        title: l.data.title,
        url: `/lore/${l.slug}`,
        category: 'lore',
        description: l.data.description,
      }));

    const relatedFactions = factions
      .filter(f => (f.data.games || []).some(g => loreGames.includes(g)))
      .slice(0, 2)
      .map(f => ({
        title: f.data.title,
        url: `/factions/${f.slug}`,
        category: 'factions',
        description: f.data.description,
      }));

    const relatedLocations = locations
      .filter(l => (l.data.games || []).some(g => loreGames.includes(g)))
      .slice(0, 2)
      .map(l => ({
        title: l.data.title,
        url: `/locations/${l.slug}`,
        category: 'locations',
        description: l.data.description,
      }));

    const relatedArticles = [
      ...relatedLore,
      ...relatedFactions,
      ...relatedLocations,
    ].slice(0, 6);

    return {
      params: { slug: entry.slug },
      props: {
        entry,
        relatedArticles,
        previousArticle: previousArticle ? { title: previousArticle.data.title, slug: previousArticle.slug } : null,
        nextArticle: nextArticle ? { title: nextArticle.data.title, slug: nextArticle.slug } : null,
      },
    };
  });
}

const { entry, relatedArticles, previousArticle, nextArticle } = Astro.props;
const { Content } = await entry.render();

const infobox: Record<string, string | string[]> = {
  'Category': entry.data.category.split('-').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
};
---

<WikiArticle
  title={entry.data.title}
  description={entry.data.description}
  image={entry.data.image}
  games={entry.data.games}
  tags={entry.data.tags}
  infobox={infobox}
  category="lore"
  relatedArticles={relatedArticles}
  previousArticle={previousArticle}
  nextArticle={nextArticle}
>
  <Content />
</WikiArticle>
