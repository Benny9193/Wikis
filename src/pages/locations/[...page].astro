---
import type { GetStaticPaths, Page } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Pagination from '../../components/Pagination.astro';
import GameFilter from '../../components/GameFilter.astro';
import { getCollection } from 'astro:content';

export const getStaticPaths = (async ({ paginate }) => {
  const locations = await getCollection('locations', ({ data }) => !data.draft);
  const sortedLocations = locations.sort((a, b) => a.data.title.localeCompare(b.data.title));

  return paginate(sortedLocations, { pageSize: 12 });
}) satisfies GetStaticPaths;

interface Props {
  page: Page;
}

const { page } = Astro.props;
const allLocations = await getCollection('locations', ({ data }) => !data.draft);
const allGames = [...new Set(allLocations.flatMap(l => l.data.games || []))].sort();
---

<BaseLayout title={`Locations${page.currentPage > 1 ? ` - Page ${page.currentPage}` : ''}`} description="Vaults, settlements, and landmarks of the wasteland">
  <div class="category-header">
    <h1>Locations</h1>
    <p>Explore the vaults, settlements, and landmarks scattered across the wasteland.</p>
    <span class="article-count">{page.total} articles</span>
  </div>

  <GameFilter games={allGames} />

  <div class="article-grid" id="articles-grid">
    {page.data.map(location => (
      <div class="article-wrapper" data-games={JSON.stringify(location.data.games || [])}>
        <ArticleCard
          title={location.data.title}
          description={location.data.description}
          href={`/locations/${location.slug}`}
          image={location.data.image}
          games={location.data.games}
        />
      </div>
    ))}
  </div>

  {page.data.length === 0 && (
    <div class="empty-state">
      <p>No locations found. Check back soon!</p>
    </div>
  )}

  <Pagination
    currentPage={page.currentPage}
    totalPages={page.lastPage}
    baseUrl="/locations"
  />
</BaseLayout>

<style>
  .category-header {
    margin-bottom: var(--spacing-lg);
  }

  .category-header p {
    color: var(--color-text-muted);
    font-size: 1.125rem;
  }

  .article-count {
    display: inline-block;
    background: var(--color-vault-blue);
    color: var(--color-text);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: 4px;
    font-size: 0.875rem;
    margin-top: var(--spacing-sm);
  }

  .article-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
  }

  .article-wrapper {
    display: block;
  }

  .article-wrapper.hidden {
    display: none;
  }

  .empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-muted);
  }

  .no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-muted);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gameSelect = document.getElementById('game-filter') as HTMLSelectElement;
    const articlesGrid = document.getElementById('articles-grid');
    const articles = articlesGrid?.querySelectorAll('.article-wrapper');

    if (!gameSelect || !articles) return;

    gameSelect.addEventListener('change', () => {
      const selectedGame = gameSelect.value;

      articles.forEach(article => {
        const wrapper = article as HTMLElement;
        const games = JSON.parse(wrapper.dataset.games || '[]');

        if (selectedGame === 'all' || games.includes(selectedGame)) {
          wrapper.classList.remove('hidden');
        } else {
          wrapper.classList.add('hidden');
        }
      });

      const visibleArticles = articlesGrid?.querySelectorAll('.article-wrapper:not(.hidden)');
      const existingNoResults = articlesGrid?.querySelector('.no-results');

      if (visibleArticles?.length === 0) {
        if (!existingNoResults) {
          const noResults = document.createElement('div');
          noResults.className = 'no-results';
          noResults.textContent = 'No articles found for this game.';
          articlesGrid?.appendChild(noResults);
        }
      } else {
        existingNoResults?.remove();
      }
    });
  });
</script>
