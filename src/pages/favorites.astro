---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Favorites" description="Your saved favorite articles">
  <div class="favorites-page">
    <div class="page-header">
      <h1>Your Favorites</h1>
      <p>Articles you've bookmarked for quick access.</p>
      <div class="favorites-actions" id="favorites-actions">
        <button class="action-btn export-btn" id="export-btn" title="Export favorites as JSON">
          <span>ðŸ“¤</span> Export
        </button>
        <label class="action-btn import-btn" title="Import favorites from JSON file">
          <span>ðŸ“¥</span> Import
          <input type="file" id="import-input" accept=".json" hidden />
        </label>
      </div>
    </div>

    <div class="favorites-list" id="favorites-list">
      <div class="loading">Loading favorites...</div>
    </div>

    <div class="favorites-empty" id="favorites-empty" style="display: none;">
      <div class="empty-icon">â˜†</div>
      <h2>No favorites yet</h2>
      <p>Click the favorite button on any article to save it here for quick access.</p>
      <a href="/random" class="cta-btn">Discover Articles</a>
    </div>
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const listEl = document.getElementById('favorites-list');
    const emptyEl = document.getElementById('favorites-empty');
    const exportBtn = document.getElementById('export-btn');
    const importInput = document.getElementById('import-input') as HTMLInputElement;

    if (!listEl || !emptyEl) return;

    // Category icons mapping
    const categoryIcons: Record<string, string> = {
      characters: 'ðŸ‘¤',
      factions: 'âš”ï¸',
      locations: 'ðŸ“',
      weapons: 'ðŸ”«',
      armor: 'ðŸ›¡ï¸',
      items: 'ðŸ“¦',
      creatures: 'ðŸ¦Ž',
      quests: 'ðŸ“œ',
      lore: 'ðŸ“–',
      perks: 'â­',
      games: 'ðŸŽ®',
    };

    // Get favorites from localStorage
    const getFavorites = (): { url: string; title: string; category?: string }[] => {
      try {
        return JSON.parse(localStorage.getItem('fallout-wiki-favorites') || '[]');
      } catch {
        return [];
      }
    };

    const favorites = getFavorites();

    if (favorites.length === 0) {
      listEl.style.display = 'none';
      emptyEl.style.display = 'block';
      return;
    }

    // Render favorites
    listEl.innerHTML = favorites.map(fav => {
      const icon = fav.category ? categoryIcons[fav.category] || 'ðŸ“„' : 'ðŸ“„';
      return `
        <a href="${fav.url}" class="favorite-item">
          <span class="favorite-category-icon" title="${fav.category || 'Article'}">${icon}</span>
          <span class="favorite-title">${fav.title}</span>
          <span class="favorite-star">â˜…</span>
          <button class="remove-btn" data-url="${fav.url}" title="Remove from favorites">Ã—</button>
        </a>
      `;
    }).join('');

    // Handle remove buttons
    listEl.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const url = (btn as HTMLButtonElement).dataset.url;
        const newFavorites = favorites.filter(f => f.url !== url);
        localStorage.setItem('fallout-wiki-favorites', JSON.stringify(newFavorites));

        // Remove from DOM
        const item = btn.closest('.favorite-item');
        item?.remove();

        // Check if empty
        if (newFavorites.length === 0) {
          listEl.style.display = 'none';
          emptyEl.style.display = 'block';
        }
      });
    });

    // Export favorites
    exportBtn?.addEventListener('click', () => {
      const data = JSON.stringify(favorites, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fallout-wiki-favorites-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Import favorites
    importInput?.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target?.result as string);

          // Validate structure
          if (!Array.isArray(imported)) {
            alert('Invalid file format. Expected an array of favorites.');
            return;
          }

          // Merge with existing, avoiding duplicates
          const existing = getFavorites();
          const existingUrls = new Set(existing.map(f => f.url));

          const newItems = imported.filter((item: any) =>
            item.url && item.title && !existingUrls.has(item.url)
          );

          if (newItems.length === 0) {
            alert('No new favorites to import. All items already exist or file was invalid.');
            return;
          }

          const merged = [...existing, ...newItems];
          localStorage.setItem('fallout-wiki-favorites', JSON.stringify(merged));

          alert(`Successfully imported ${newItems.length} new favorite(s). Refreshing page...`);
          window.location.reload();
        } catch (err) {
          alert('Failed to parse file. Please ensure it is a valid JSON file.');
        }
      };
      reader.readAsText(file);

      // Reset input so same file can be imported again
      importInput.value = '';
    });
  });
</script>

<style>
  .favorites-page {
    max-width: 800px;
    margin: 0 auto;
  }

  .page-header {
    margin-bottom: var(--spacing-xl);
    text-align: center;
  }

  .page-header p {
    color: var(--color-text-muted);
    font-size: 1.125rem;
  }

  .favorites-actions {
    display: flex;
    justify-content: center;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    color: var(--color-text);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .action-btn:hover {
    border-color: var(--color-pip-green);
    background: rgba(24, 255, 109, 0.1);
  }

  .export-btn:hover {
    border-color: var(--color-pip-amber);
    background: rgba(255, 176, 0, 0.1);
    color: var(--color-pip-amber);
  }

  .import-btn:hover {
    border-color: var(--color-pip-green);
    background: rgba(24, 255, 109, 0.1);
    color: var(--color-pip-green);
  }

  .favorites-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .loading {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-muted);
  }

  .favorite-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .favorite-item:hover {
    border-color: var(--color-pip-green);
    background: rgba(24, 255, 109, 0.05);
    text-decoration: none;
  }

  .favorite-category-icon {
    font-size: 1.25rem;
    width: 28px;
    text-align: center;
    flex-shrink: 0;
  }

  .favorite-star {
    color: var(--color-pip-amber);
    font-size: 1rem;
    opacity: 0.6;
  }

  .favorite-title {
    flex: 1;
    color: var(--color-text);
    font-weight: 500;
  }

  .favorite-item:hover .favorite-title {
    color: var(--color-pip-amber);
  }

  .remove-btn {
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0 var(--spacing-sm);
    line-height: 1;
    transition: color 0.2s;
  }

  .remove-btn:hover {
    color: var(--color-nuka-red);
  }

  .favorites-empty {
    text-align: center;
    padding: var(--spacing-xl);
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    border-radius: 8px;
  }

  .empty-icon {
    font-size: 4rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-md);
  }

  .favorites-empty h2 {
    color: var(--color-pip-amber);
    margin-bottom: var(--spacing-sm);
  }

  .favorites-empty p {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  .cta-btn {
    display: inline-block;
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-pip-green);
    color: var(--color-bg-dark);
    border-radius: 4px;
    font-weight: bold;
    text-decoration: none;
    transition: background 0.2s;
  }

  .cta-btn:hover {
    background: var(--color-pip-amber);
    text-decoration: none;
  }
</style>
