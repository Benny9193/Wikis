---
import WikiArticle from '../../layouts/WikiArticle.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const armor = await getCollection('armor', ({ data }) => !data.draft);
  const allArmor = await getCollection('armor', ({ data }) => !data.draft);
  const weapons = await getCollection('weapons', ({ data }) => !data.draft);
  const perks = await getCollection('perks', ({ data }) => !data.draft);
  const characters = await getCollection('characters', ({ data }) => !data.draft);

  return armor.map(item => {
    const armorGames = item.data.games || [];
    const armorType = item.data.type;

    const relatedArmor = allArmor
      .filter(a => a.slug !== item.slug)
      .filter(a => {
        const sameGame = (a.data.games || []).some(g => armorGames.includes(g));
        const sameType = a.data.type === armorType;
        return sameGame || sameType;
      })
      .slice(0, 3)
      .map(a => ({
        title: a.data.title,
        url: `/armor/${a.slug}`,
        category: 'armor',
        description: a.data.description,
      }));

    const relatedWeapons = weapons
      .filter(w => (w.data.games || []).some(g => armorGames.includes(g)))
      .slice(0, 2)
      .map(w => ({
        title: w.data.title,
        url: `/weapons/${w.slug}`,
        category: 'weapons',
        description: w.data.description,
      }));

    const relatedPerks = perks
      .filter(p => (p.data.games || []).some(g => armorGames.includes(g)))
      .slice(0, 2)
      .map(p => ({
        title: p.data.title,
        url: `/perks/${p.slug}`,
        category: 'perks',
        description: p.data.description,
      }));

    const relatedArticles = [
      ...relatedArmor,
      ...relatedWeapons,
      ...relatedPerks,
    ].slice(0, 6);

    return {
      params: { slug: item.slug },
      props: { armor: item, relatedArticles },
    };
  });
}

const { armor, relatedArticles } = Astro.props;
const { Content } = await armor.render();

const infobox: Record<string, string | string[]> = {
  'Type': armor.data.type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
};

if (armor.data.damage_resistance) {
  infobox['Damage Resistance'] = armor.data.damage_resistance;
}

if (armor.data.weight !== undefined) {
  infobox['Weight'] = `${armor.data.weight} lbs`;
}

if (armor.data.value !== undefined) {
  infobox['Value'] = `${armor.data.value} caps`;
}

infobox['Unique'] = armor.data.unique ? 'Yes' : 'No';
---

<WikiArticle
  title={armor.data.title}
  description={armor.data.description}
  image={armor.data.image}
  games={armor.data.games}
  tags={armor.data.tags}
  infobox={infobox}
  category="armor"
  relatedArticles={relatedArticles}
>
  <Content />
</WikiArticle>
