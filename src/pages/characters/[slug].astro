---
import WikiArticle from '../../layouts/WikiArticle.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const characters = await getCollection('characters', ({ data }) => !data.draft);
  const allCharacters = await getCollection('characters', ({ data }) => !data.draft);
  const locations = await getCollection('locations', ({ data }) => !data.draft);
  const quests = await getCollection('quests', ({ data }) => !data.draft);
  const factions = await getCollection('factions', ({ data }) => !data.draft);
  const weapons = await getCollection('weapons', ({ data }) => !data.draft);

  return characters.map(character => {
    // Find related articles by shared games or tags
    const charGames = character.data.games || [];
    const charTags = character.data.tags || [];

    const relatedCharacters = allCharacters
      .filter(c => c.slug !== character.slug)
      .filter(c => {
        const sharedGames = (c.data.games || []).some(g => charGames.includes(g));
        const sharedTags = (c.data.tags || []).some(t => charTags.includes(t));
        return sharedGames || sharedTags;
      })
      .slice(0, 3)
      .map(c => ({
        title: c.data.title,
        url: `/characters/${c.slug}`,
        category: 'characters',
        description: c.data.description,
      }));

    const relatedLocations = locations
      .filter(l => (l.data.games || []).some(g => charGames.includes(g)))
      .slice(0, 2)
      .map(l => ({
        title: l.data.title,
        url: `/locations/${l.slug}`,
        category: 'locations',
        description: l.data.description,
      }));

    const relatedQuests = quests
      .filter(q => (q.data.games || []).some(g => charGames.includes(g)))
      .slice(0, 2)
      .map(q => ({
        title: q.data.title,
        url: `/quests/${q.slug}`,
        category: 'quests',
        description: q.data.description,
      }));

    const relatedFactions = factions
      .filter(f => (f.data.games || []).some(g => charGames.includes(g)))
      .slice(0, 2)
      .map(f => ({
        title: f.data.title,
        url: `/factions/${f.slug}`,
        category: 'factions',
        description: f.data.description,
      }));

    const relatedWeapons = weapons
      .filter(w => (w.data.games || []).some(g => charGames.includes(g)))
      .slice(0, 2)
      .map(w => ({
        title: w.data.title,
        url: `/weapons/${w.slug}`,
        category: 'weapons',
        description: w.data.description,
      }));

    const relatedArticles = [
      ...relatedCharacters,
      ...relatedLocations,
      ...relatedQuests,
      ...relatedFactions,
      ...relatedWeapons,
    ].slice(0, 6);

    return {
      params: { slug: character.slug },
      props: { character, relatedArticles },
    };
  });
}

const { character, relatedArticles } = Astro.props;
const { Content } = await character.render();

const infobox: Record<string, string | string[]> = {
  'Race': character.data.race.charAt(0).toUpperCase() + character.data.race.slice(1).replace('-', ' '),
  'Status': character.data.status.charAt(0).toUpperCase() + character.data.status.slice(1),
};

if (character.data.affiliation?.length > 0) {
  infobox['Affiliation'] = character.data.affiliation;
}

if (character.data.voice_actor) {
  infobox['Voice Actor'] = character.data.voice_actor;
}
---

<WikiArticle
  title={character.data.title}
  description={character.data.description}
  image={character.data.image}
  games={character.data.games}
  tags={character.data.tags}
  infobox={infobox}
  category="characters"
  relatedArticles={relatedArticles}
>
  <Content />
</WikiArticle>
