---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { getCollection } from 'astro:content';

const characters = await getCollection('characters', ({ data }) => !data.draft);
const sortedCharacters = characters.sort((a, b) => a.data.title.localeCompare(b.data.title));

// Get all unique games from characters
const allGames = [...new Set(characters.flatMap(c => c.data.games || []))].sort();

const gameLabels: Record<string, string> = {
  'fallout1': 'Fallout',
  'fallout2': 'Fallout 2',
  'fallout3': 'Fallout 3',
  'fallout-new-vegas': 'New Vegas',
  'fallout4': 'Fallout 4',
  'fallout76': 'Fallout 76',
  'fallout-tactics': 'Tactics',
  'fallout-shelter': 'Shelter',
  'fallout-brotherhood': 'Brotherhood',
};
---

<BaseLayout title="Characters" description="Companions, NPCs, and protagonists of the Fallout universe">
  <div class="category-header">
    <h1>Characters</h1>
    <p>Meet the memorable characters of the Fallout universeâ€”from protagonists to companions to villains.</p>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="game-filter">Filter by Game:</label>
      <select id="game-filter" class="game-select">
        <option value="all">All Games</option>
        {allGames.map(game => (
          <option value={game}>{gameLabels[game] || game}</option>
        ))}
      </select>
    </div>
    <div class="filter-group">
      <span class="filter-label">Type:</span>
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="human">Human</button>
      <button class="filter-btn" data-filter="ghoul">Ghoul</button>
      <button class="filter-btn" data-filter="super-mutant">Super Mutant</button>
      <button class="filter-btn" data-filter="synth">Synth</button>
      <button class="filter-btn" data-filter="robot">Robot</button>
    </div>
  </div>

  <div class="article-grid" id="articles-grid">
    {sortedCharacters.map(character => (
      <div class="article-wrapper" data-games={JSON.stringify(character.data.games || [])}>
        <ArticleCard
          title={character.data.title}
          description={character.data.description}
          href={`/characters/${character.slug}`}
          image={character.data.image}
          games={character.data.games}
        />
      </div>
    ))}
  </div>

  {sortedCharacters.length === 0 && (
    <div class="empty-state">
      <p>No characters found. Check back soon!</p>
    </div>
  )}
</BaseLayout>

<style>
  .category-header {
    margin-bottom: var(--spacing-lg);
  }

  .category-header p {
    color: var(--color-text-muted);
    font-size: 1.125rem;
  }

  .filters {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-lg);
    border-bottom: 2px solid var(--color-pip-green);
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .filter-group label,
  .filter-label {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .game-select {
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    min-width: 150px;
  }

  .game-select:focus {
    outline: none;
    border-color: var(--color-pip-green);
  }

  .game-select option {
    background: var(--color-bg-darker);
    color: var(--color-text);
  }

  .filter-btn {
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-btn:hover,
  .filter-btn.active {
    background: var(--color-pip-green);
    color: var(--color-bg-dark);
    border-color: var(--color-pip-green);
  }

  .article-wrapper {
    display: block;
  }

  .article-wrapper.hidden {
    display: none;
  }

  .article-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
  }

  .empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-muted);
  }

  .no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-muted);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gameSelect = document.getElementById('game-filter') as HTMLSelectElement;
    const articlesGrid = document.getElementById('articles-grid');
    const articles = articlesGrid?.querySelectorAll('.article-wrapper');

    if (!gameSelect || !articles) return;

    gameSelect.addEventListener('change', () => {
      const selectedGame = gameSelect.value;

      articles.forEach(article => {
        const wrapper = article as HTMLElement;
        const games = JSON.parse(wrapper.dataset.games || '[]');

        if (selectedGame === 'all' || games.includes(selectedGame)) {
          wrapper.classList.remove('hidden');
        } else {
          wrapper.classList.add('hidden');
        }
      });

      // Check if any results visible
      const visibleArticles = articlesGrid?.querySelectorAll('.article-wrapper:not(.hidden)');
      const existingNoResults = articlesGrid?.querySelector('.no-results');

      if (visibleArticles?.length === 0) {
        if (!existingNoResults) {
          const noResults = document.createElement('div');
          noResults.className = 'no-results';
          noResults.textContent = 'No articles found for this game.';
          articlesGrid?.appendChild(noResults);
        }
      } else {
        existingNoResults?.remove();
      }
    });
  });
</script>
