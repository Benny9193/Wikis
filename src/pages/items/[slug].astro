---
import WikiArticle from '../../layouts/WikiArticle.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const items = await getCollection('items', ({ data }) => !data.draft);
  const allItems = await getCollection('items', ({ data }) => !data.draft);
  const weapons = await getCollection('weapons', ({ data }) => !data.draft);
  const armor = await getCollection('armor', ({ data }) => !data.draft);
  const locations = await getCollection('locations', ({ data }) => !data.draft);

  const sortedItems = [...items].sort((a, b) => a.data.title.localeCompare(b.data.title));

  return items.map(item => {
    const currentIndex = sortedItems.findIndex(i => i.slug === item.slug);
    const previousArticle = currentIndex > 0 ? sortedItems[currentIndex - 1] : null;
    const nextArticle = currentIndex < sortedItems.length - 1 ? sortedItems[currentIndex + 1] : null;
    const itemGames = item.data.games || [];
    const itemType = item.data.type;

    const relatedItems = allItems
      .filter(i => i.slug !== item.slug)
      .filter(i => {
        const sameGame = (i.data.games || []).some(g => itemGames.includes(g));
        const sameType = i.data.type === itemType;
        return sameGame || sameType;
      })
      .slice(0, 3)
      .map(i => ({
        title: i.data.title,
        url: `/items/${i.slug}`,
        category: 'items',
        description: i.data.description,
      }));

    const relatedWeapons = weapons
      .filter(w => (w.data.games || []).some(g => itemGames.includes(g)))
      .slice(0, 2)
      .map(w => ({
        title: w.data.title,
        url: `/weapons/${w.slug}`,
        category: 'weapons',
        description: w.data.description,
      }));

    const relatedArmor = armor
      .filter(a => (a.data.games || []).some(g => itemGames.includes(g)))
      .slice(0, 2)
      .map(a => ({
        title: a.data.title,
        url: `/armor/${a.slug}`,
        category: 'armor',
        description: a.data.description,
      }));

    const relatedArticles = [
      ...relatedItems,
      ...relatedWeapons,
      ...relatedArmor,
    ].slice(0, 6);

    return {
      params: { slug: item.slug },
      props: {
        item,
        relatedArticles,
        previousArticle: previousArticle ? { title: previousArticle.data.title, slug: previousArticle.slug } : null,
        nextArticle: nextArticle ? { title: nextArticle.data.title, slug: nextArticle.slug } : null,
      },
    };
  });
}

const { item, relatedArticles, previousArticle, nextArticle } = Astro.props;
const { Content } = await item.render();

const infobox: Record<string, string | string[]> = {
  'Type': item.data.type.charAt(0).toUpperCase() + item.data.type.slice(1),
};

if (item.data.effects?.length > 0) {
  infobox['Effects'] = item.data.effects;
}

if (item.data.weight) {
  infobox['Weight'] = `${item.data.weight} lbs`;
}

if (item.data.value) {
  infobox['Value'] = `${item.data.value} caps`;
}
---

<WikiArticle
  title={item.data.title}
  description={item.data.description}
  image={item.data.image}
  games={item.data.games}
  tags={item.data.tags}
  infobox={infobox}
  category="items"
  relatedArticles={relatedArticles}
  previousArticle={previousArticle}
  nextArticle={nextArticle}
>
  <Content />
</WikiArticle>
