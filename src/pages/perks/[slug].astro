---
import WikiArticle from '../../layouts/WikiArticle.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const perks = await getCollection('perks', ({ data }) => !data.draft);
  const allPerks = await getCollection('perks', ({ data }) => !data.draft);
  const weapons = await getCollection('weapons', ({ data }) => !data.draft);
  const armor = await getCollection('armor', ({ data }) => !data.draft);
  const characters = await getCollection('characters', ({ data }) => !data.draft);

  const sortedPerks = [...perks].sort((a, b) => a.data.title.localeCompare(b.data.title));

  return perks.map(perk => {
    const currentIndex = sortedPerks.findIndex(p => p.slug === perk.slug);
    const previousArticle = currentIndex > 0 ? sortedPerks[currentIndex - 1] : null;
    const nextArticle = currentIndex < sortedPerks.length - 1 ? sortedPerks[currentIndex + 1] : null;
    const perkGames = perk.data.games || [];
    const perkType = perk.data.type;

    const relatedPerks = allPerks
      .filter(p => p.slug !== perk.slug)
      .filter(p => {
        const sameGame = (p.data.games || []).some(g => perkGames.includes(g));
        const sameType = p.data.type === perkType;
        return sameGame || sameType;
      })
      .slice(0, 3)
      .map(p => ({
        title: p.data.title,
        url: `/perks/${p.slug}`,
        category: 'perks',
        description: p.data.description,
      }));

    const relatedWeapons = weapons
      .filter(w => (w.data.games || []).some(g => perkGames.includes(g)))
      .slice(0, 2)
      .map(w => ({
        title: w.data.title,
        url: `/weapons/${w.slug}`,
        category: 'weapons',
        description: w.data.description,
      }));

    const relatedArmor = armor
      .filter(a => (a.data.games || []).some(g => perkGames.includes(g)))
      .slice(0, 2)
      .map(a => ({
        title: a.data.title,
        url: `/armor/${a.slug}`,
        category: 'armor',
        description: a.data.description,
      }));

    const relatedArticles = [
      ...relatedPerks,
      ...relatedWeapons,
      ...relatedArmor,
    ].slice(0, 6);

    return {
      params: { slug: perk.slug },
      props: {
        perk,
        relatedArticles,
        previousArticle: previousArticle ? { title: previousArticle.data.title, slug: previousArticle.slug } : null,
        nextArticle: nextArticle ? { title: nextArticle.data.title, slug: nextArticle.slug } : null,
      },
    };
  });
}

const { perk, relatedArticles, previousArticle, nextArticle } = Astro.props;
const { Content } = await perk.render();

const infobox: Record<string, string | string[]> = {
  'Type': perk.data.type.charAt(0).toUpperCase() + perk.data.type.slice(1),
};

if (perk.data.requirements) {
  infobox['Requirements'] = perk.data.requirements;
}

if (perk.data.ranks) {
  infobox['Ranks'] = `${perk.data.ranks}`;
}

if (perk.data.effects && perk.data.effects.length > 0) {
  infobox['Effects'] = perk.data.effects;
}
---

<WikiArticle
  title={perk.data.title}
  description={perk.data.description}
  image={perk.data.image}
  games={perk.data.games}
  tags={perk.data.tags}
  infobox={infobox}
  category="perks"
  relatedArticles={relatedArticles}
  previousArticle={previousArticle}
  nextArticle={nextArticle}
>
  <Content />
</WikiArticle>
