---
import WikiArticle from '../../layouts/WikiArticle.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const factions = await getCollection('factions', ({ data }) => !data.draft);
  const allFactions = await getCollection('factions', ({ data }) => !data.draft);
  const characters = await getCollection('characters', ({ data }) => !data.draft);
  const locations = await getCollection('locations', ({ data }) => !data.draft);
  const quests = await getCollection('quests', ({ data }) => !data.draft);

  return factions.map(faction => {
    const factionGames = faction.data.games || [];

    const relatedFactions = allFactions
      .filter(f => f.slug !== faction.slug)
      .filter(f => (f.data.games || []).some(g => factionGames.includes(g)))
      .slice(0, 2)
      .map(f => ({
        title: f.data.title,
        url: `/factions/${f.slug}`,
        category: 'factions',
        description: f.data.description,
      }));

    const relatedCharacters = characters
      .filter(c => (c.data.games || []).some(g => factionGames.includes(g)))
      .slice(0, 2)
      .map(c => ({
        title: c.data.title,
        url: `/characters/${c.slug}`,
        category: 'characters',
        description: c.data.description,
      }));

    const relatedLocations = locations
      .filter(l => (l.data.games || []).some(g => factionGames.includes(g)))
      .slice(0, 2)
      .map(l => ({
        title: l.data.title,
        url: `/locations/${l.slug}`,
        category: 'locations',
        description: l.data.description,
      }));

    const relatedQuests = quests
      .filter(q => (q.data.games || []).some(g => factionGames.includes(g)))
      .slice(0, 2)
      .map(q => ({
        title: q.data.title,
        url: `/quests/${q.slug}`,
        category: 'quests',
        description: q.data.description,
      }));

    const relatedArticles = [
      ...relatedFactions,
      ...relatedCharacters,
      ...relatedLocations,
      ...relatedQuests,
    ].slice(0, 6);

    return {
      params: { slug: faction.slug },
      props: { faction, relatedArticles },
    };
  });
}

const { faction, relatedArticles } = Astro.props;
const { Content } = await faction.render();

const infobox: Record<string, string | string[]> = {
  'Type': faction.data.type.charAt(0).toUpperCase() + faction.data.type.slice(1),
};

if (faction.data.headquarters) {
  infobox['Headquarters'] = faction.data.headquarters;
}

if (faction.data.leaders?.length > 0) {
  infobox['Leaders'] = faction.data.leaders;
}

if (faction.data.allies?.length > 0) {
  infobox['Allies'] = faction.data.allies;
}

if (faction.data.enemies?.length > 0) {
  infobox['Enemies'] = faction.data.enemies;
}
---

<WikiArticle
  title={faction.data.title}
  description={faction.data.description}
  image={faction.data.image}
  games={faction.data.games}
  tags={faction.data.tags}
  infobox={infobox}
  category="factions"
  relatedArticles={relatedArticles}
>
  <Content />
</WikiArticle>
