---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import GameFilter from '../../components/GameFilter.astro';
import { getCollection } from 'astro:content';

const factions = await getCollection('factions', ({ data }) => !data.draft);
const sortedFactions = factions.sort((a, b) => a.data.title.localeCompare(b.data.title));
const allGames = [...new Set(factions.flatMap(f => f.data.games || []))];
---

<BaseLayout title="Factions" description="Organizations, groups, and powers vying for control of the wasteland">
  <div class="category-header">
    <h1>Factions</h1>
    <p>From the Brotherhood of Steel to Caesar's Legion, discover the groups shaping the wasteland.</p>
  </div>

  <GameFilter games={allGames} />

  <div class="article-grid" id="articles-grid">
    {sortedFactions.map(faction => (
      <div class="article-wrapper" data-games={JSON.stringify(faction.data.games || [])}>
        <ArticleCard
          title={faction.data.title}
          description={faction.data.description}
          href={`/factions/${faction.slug}`}
          image={faction.data.image}
          games={faction.data.games}
        />
      </div>
    ))}
  </div>

  {sortedFactions.length === 0 && (
    <div class="empty-state">
      <p>No factions found. Check back soon!</p>
    </div>
  )}
</BaseLayout>

<style>
  .category-header {
    margin-bottom: var(--spacing-lg);
  }

  .category-header p {
    color: var(--color-text-muted);
    font-size: 1.125rem;
  }

  .article-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
  }

  .article-wrapper {
    display: block;
  }

  .article-wrapper.hidden {
    display: none;
  }

  .empty-state,
  .no-results {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-muted);
    grid-column: 1 / -1;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gameSelect = document.getElementById('game-filter') as HTMLSelectElement;
    const articlesGrid = document.getElementById('articles-grid');
    const articles = articlesGrid?.querySelectorAll('.article-wrapper');

    if (!gameSelect || !articles) return;

    gameSelect.addEventListener('change', () => {
      const selectedGame = gameSelect.value;

      articles.forEach(article => {
        const wrapper = article as HTMLElement;
        const games = JSON.parse(wrapper.dataset.games || '[]');

        if (selectedGame === 'all' || games.includes(selectedGame)) {
          wrapper.classList.remove('hidden');
        } else {
          wrapper.classList.add('hidden');
        }
      });

      const visibleArticles = articlesGrid?.querySelectorAll('.article-wrapper:not(.hidden)');
      const existingNoResults = articlesGrid?.querySelector('.no-results');

      if (visibleArticles?.length === 0) {
        if (!existingNoResults) {
          const noResults = document.createElement('div');
          noResults.className = 'no-results';
          noResults.textContent = 'No articles found for this game.';
          articlesGrid?.appendChild(noResults);
        }
      } else {
        existingNoResults?.remove();
      }
    });
  });
</script>
