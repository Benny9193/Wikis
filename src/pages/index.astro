---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { getCollection } from 'astro:content';

const games = await getCollection('games');
const characters = await getCollection('characters', ({ data }) => !data.draft);
const factions = await getCollection('factions', ({ data }) => !data.draft);
const locations = await getCollection('locations', ({ data }) => !data.draft);
const weapons = await getCollection('weapons', ({ data }) => !data.draft);
const quests = await getCollection('quests', ({ data }) => !data.draft);
const creatures = await getCollection('creatures', ({ data }) => !data.draft);
const armor = await getCollection('armor', ({ data }) => !data.draft);
const items = await getCollection('items', ({ data }) => !data.draft);
const lore = await getCollection('lore', ({ data }) => !data.draft);
const perks = await getCollection('perks', ({ data }) => !data.draft);

// Build featured articles from across all categories
interface FeaturedArticle {
  title: string;
  description: string;
  slug: string;
  category: string;
  categoryLabel: string;
  image?: string;
  games?: string[];
}

const featuredArticles: FeaturedArticle[] = [
  ...characters.slice(0, 2).map(c => ({
    title: c.data.title,
    description: c.data.description,
    slug: c.slug,
    category: 'characters',
    categoryLabel: 'Character',
    image: c.data.image,
    games: c.data.games,
  })),
  ...locations.slice(0, 2).map(l => ({
    title: l.data.title,
    description: l.data.description,
    slug: l.slug,
    category: 'locations',
    categoryLabel: 'Location',
    image: l.data.image,
    games: l.data.games,
  })),
  ...weapons.slice(0, 1).map(w => ({
    title: w.data.title,
    description: w.data.description,
    slug: w.slug,
    category: 'weapons',
    categoryLabel: 'Weapon',
    image: w.data.image,
    games: w.data.games,
  })),
  ...creatures.slice(0, 1).map(c => ({
    title: c.data.title,
    description: c.data.description,
    slug: c.slug,
    category: 'creatures',
    categoryLabel: 'Creature',
    image: c.data.image,
    games: c.data.games,
  })),
].slice(0, 6);

// Get featured/recent content
const featuredCharacters = characters.slice(0, 4);
const featuredFactions = factions.slice(0, 4);

// Build "Recently Updated" - pulling latest from each category
// In a real scenario, you'd sort by lastUpdated date
interface RecentArticle {
  title: string;
  description: string;
  slug: string;
  category: string;
  categoryLabel: string;
  image?: string;
}

const recentArticles: RecentArticle[] = [
  ...quests.slice(-1).map(q => ({
    title: q.data.title,
    description: q.data.description,
    slug: q.slug,
    category: 'quests',
    categoryLabel: 'Quest',
    image: q.data.image,
  })),
  ...armor.slice(-1).map(a => ({
    title: a.data.title,
    description: a.data.description,
    slug: a.slug,
    category: 'armor',
    categoryLabel: 'Armor',
    image: a.data.image,
  })),
  ...items.slice(-1).map(i => ({
    title: i.data.title,
    description: i.data.description,
    slug: i.slug,
    category: 'items',
    categoryLabel: 'Item',
    image: i.data.image,
  })),
  ...lore.slice(-1).map(l => ({
    title: l.data.title,
    description: l.data.description,
    slug: l.slug,
    category: 'lore',
    categoryLabel: 'Lore',
    image: l.data.image,
  })),
  ...perks.slice(-1).map(p => ({
    title: p.data.title,
    description: p.data.description,
    slug: p.slug,
    category: 'perks',
    categoryLabel: 'Perk',
    image: p.data.image,
  })),
  ...factions.slice(-1).map(f => ({
    title: f.data.title,
    description: f.data.description,
    slug: f.slug,
    category: 'factions',
    categoryLabel: 'Faction',
    image: f.data.image,
  })),
].slice(0, 6);

// Count total articles
const totalArticles = characters.length + factions.length + locations.length +
  weapons.length + armor.length + items.length + creatures.length +
  quests.length + lore.length + perks.length;
---

<BaseLayout title="Home" description="Welcome to the Fallout Wiki - Your comprehensive guide to the post-apocalyptic wasteland">
  <section class="hero">
    <div class="hero-content">
      <h1>Welcome to the Wasteland</h1>
      <p class="hero-tagline">Your comprehensive guide to the Fallout universe</p>
      <div class="hero-stats">
        <div class="stat">
          <span class="stat-number">{games.length}</span>
          <span class="stat-label">Games</span>
        </div>
        <div class="stat">
          <span class="stat-number">{totalArticles}</span>
          <span class="stat-label">Articles</span>
        </div>
        <div class="stat">
          <span class="stat-number">11</span>
          <span class="stat-label">Categories</span>
        </div>
      </div>
    </div>
  </section>

  <section class="categories">
    <h2>Explore the Wiki</h2>
    <div class="category-grid">
      <a href="/games" class="category-card">
        <span class="category-icon">üéÆ</span>
        <h3>Games</h3>
        <p>All Fallout titles from 1997 to present</p>
      </a>
      <a href="/characters" class="category-card">
        <span class="category-icon">üë§</span>
        <h3>Characters</h3>
        <p>NPCs, companions, and protagonists</p>
      </a>
      <a href="/factions" class="category-card">
        <span class="category-icon">‚öîÔ∏è</span>
        <h3>Factions</h3>
        <p>NCR, Brotherhood of Steel, and more</p>
      </a>
      <a href="/locations" class="category-card">
        <span class="category-icon">üó∫Ô∏è</span>
        <h3>Locations</h3>
        <p>Vaults, cities, and landmarks</p>
      </a>
      <a href="/weapons" class="category-card">
        <span class="category-icon">üî´</span>
        <h3>Weapons</h3>
        <p>From pipe pistols to Fat Man</p>
      </a>
      <a href="/armor" class="category-card">
        <span class="category-icon">üõ°Ô∏è</span>
        <h3>Armor</h3>
        <p>Power Armor and protective gear</p>
      </a>
      <a href="/items" class="category-card">
        <span class="category-icon">üíä</span>
        <h3>Items</h3>
        <p>Stimpaks, Nuka-Cola, and chems</p>
      </a>
      <a href="/creatures" class="category-card">
        <span class="category-icon">ü¶é</span>
        <h3>Creatures</h3>
        <p>Deathclaws, Radscorpions, and mutants</p>
      </a>
      <a href="/quests" class="category-card">
        <span class="category-icon">üìú</span>
        <h3>Quests</h3>
        <p>Main stories and side adventures</p>
      </a>
      <a href="/lore" class="category-card">
        <span class="category-icon">üìñ</span>
        <h3>Lore</h3>
        <p>History, timeline, and world-building</p>
      </a>
      <a href="/perks" class="category-card">
        <span class="category-icon">‚≠ê</span>
        <h3>Perks</h3>
        <p>Abilities, traits, and skills</p>
      </a>
    </div>
  </section>

  {featuredArticles.length > 0 && (
    <section class="featured-articles">
      <h2>Featured Articles</h2>
      <div class="featured-grid">
        {featuredArticles.map(article => (
          <a href={`/${article.category}/${article.slug}`} class="featured-card">
            <div class="featured-image">
              <img src={article.image || `/images/placeholder-${article.category}.svg`} alt={article.title} />
              <span class="featured-category">{article.categoryLabel}</span>
            </div>
            <div class="featured-content">
              <h3>{article.title}</h3>
              <p>{article.description}</p>
              {article.games && article.games.length > 0 && (
                <div class="featured-games">
                  {article.games.slice(0, 2).map(game => (
                    <span class="game-tag">{game}</span>
                  ))}
                </div>
              )}
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  {recentArticles.length > 0 && (
    <section class="recent-updates">
      <h2>Recently Updated</h2>
      <div class="recent-grid">
        {recentArticles.map(article => (
          <a href={`/${article.category}/${article.slug}`} class="recent-card">
            <span class="recent-category">{article.categoryLabel}</span>
            <span class="recent-title">{article.title}</span>
          </a>
        ))}
      </div>
    </section>
  )}

  {featuredCharacters.length > 0 && (
    <section class="featured">
      <h2>Featured Characters</h2>
      <div class="article-grid">
        {featuredCharacters.map(char => (
          <ArticleCard
            title={char.data.title}
            description={char.data.description}
            href={`/characters/${char.slug}`}
            image={char.data.image}
            games={char.data.games}
          />
        ))}
      </div>
    </section>
  )}

  {featuredFactions.length > 0 && (
    <section class="featured">
      <h2>Major Factions</h2>
      <div class="article-grid">
        {featuredFactions.map(faction => (
          <ArticleCard
            title={faction.data.title}
            description={faction.data.description}
            href={`/factions/${faction.slug}`}
            image={faction.data.image}
            games={faction.data.games}
          />
        ))}
      </div>
    </section>
  )}
</BaseLayout>

<style>
  .hero {
    background: linear-gradient(135deg, var(--color-vault-blue), var(--color-bg-darker));
    border: 2px solid var(--color-pip-green);
    border-radius: 12px;
    padding: var(--spacing-xl);
    text-align: center;
    margin-bottom: var(--spacing-xl);
  }

  .hero h1 {
    font-size: 3rem;
    margin-bottom: var(--spacing-sm);
  }

  .hero-tagline {
    font-size: 1.25rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  .hero-stats {
    display: flex;
    justify-content: center;
    gap: var(--spacing-xl);
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--color-pip-green);
  }

  .stat-label {
    color: var(--color-text-muted);
    text-transform: uppercase;
    font-size: 0.875rem;
  }

  .categories {
    margin-bottom: var(--spacing-xl);
  }

  .categories h2 {
    margin-bottom: var(--spacing-lg);
  }

  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--spacing-md);
  }

  .category-card {
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: var(--spacing-lg);
    text-align: center;
    transition: transform 0.2s, border-color 0.2s;
    text-decoration: none;
  }

  .category-card:hover {
    transform: translateY(-4px);
    border-color: var(--color-pip-green);
    text-decoration: none;
  }

  .category-icon {
    font-size: 2.5rem;
    display: block;
    margin-bottom: var(--spacing-sm);
  }

  .category-card h3 {
    color: var(--color-pip-amber);
    margin-bottom: var(--spacing-xs);
  }

  .category-card p {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    margin: 0;
  }

  .recent-updates {
    margin-bottom: var(--spacing-xl);
  }

  .recent-updates h2 {
    margin-bottom: var(--spacing-lg);
  }

  .recent-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--spacing-md);
  }

  .recent-card {
    display: flex;
    flex-direction: column;
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-pip-green);
    padding: var(--spacing-md);
    text-decoration: none;
    transition: all 0.2s;
  }

  .recent-card:hover {
    border-color: var(--color-pip-green);
    background: rgba(24, 255, 109, 0.05);
    text-decoration: none;
  }

  .recent-category {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--color-pip-green);
    margin-bottom: var(--spacing-xs);
    font-weight: bold;
  }

  .recent-title {
    color: var(--color-text);
    font-weight: 500;
  }

  .recent-card:hover .recent-title {
    color: var(--color-pip-amber);
  }

  .featured {
    margin-bottom: var(--spacing-xl);
  }

  .featured h2 {
    margin-bottom: var(--spacing-lg);
  }

  .article-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-lg);
  }

  .featured-articles {
    margin-bottom: var(--spacing-xl);
  }

  .featured-articles h2 {
    margin-bottom: var(--spacing-lg);
  }

  .featured-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--spacing-lg);
  }

  .featured-card {
    background: var(--color-bg-darker);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    overflow: hidden;
    text-decoration: none;
    transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
  }

  .featured-card:hover {
    transform: translateY(-4px);
    border-color: var(--color-pip-green);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    text-decoration: none;
  }

  .featured-image {
    position: relative;
    height: 160px;
    overflow: hidden;
  }

  .featured-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .featured-category {
    position: absolute;
    top: var(--spacing-sm);
    left: var(--spacing-sm);
    background: var(--color-pip-green);
    color: var(--color-bg-dark);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
  }

  .featured-content {
    padding: var(--spacing-md);
  }

  .featured-content h3 {
    color: var(--color-pip-amber);
    margin-bottom: var(--spacing-xs);
    font-size: 1.125rem;
  }

  .featured-content p {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    margin-bottom: var(--spacing-sm);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .featured-games {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
  }

  .game-tag {
    background: var(--color-vault-blue);
    color: var(--color-text);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    text-transform: uppercase;
  }
</style>
